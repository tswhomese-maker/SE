<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢ç¢¼æ¯”å°å°å·¥å…· - Code 39 å°ˆç”¨</title>
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --error: #dc3545; }
        body { font-family: -apple-system, sans-serif; text-align: center; background-color: #f8f9fa; padding: 10px; margin: 0; }
        h2 { color: #333; margin: 15px 0; }
        #reader { 
            width: 100%; 
            max-width: 500px; 
            margin: auto; 
            border-radius: 12px; 
            overflow: hidden; 
            background: #000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: border 0.3s;
        }
        .info { background: white; padding: 20px; border-radius: 12px; margin: 15px auto; max-width: 460px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .code-box { 
            font-family: 'Courier New', monospace; 
            font-size: 1.1em; 
            padding: 12px; 
            border: 2px solid #ddd; 
            margin: 10px 0; 
            border-radius: 8px; 
            word-break: break-all; 
            min-height: 1.5em;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        .active-scan { border-color: var(--primary); background-color: #f0f7ff; }
        .success { border: 3px solid var(--success) !important; background-color: #e6ffed !important; }
        .error { border: 3px solid var(--error) !important; background-color: #fff5f5 !important; }
        .scanning { border: 3px solid #ffc107 !important; }
        #msg { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; min-height: 2em; }
        button { 
            width: 100%; 
            padding: 15px; 
            font-size: 1.1em; 
            cursor: pointer; 
            border-radius: 8px; 
            border: none; 
            background: var(--primary); 
            color: white; 
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        .hint { 
            color: #666; 
            font-size: 0.9em; 
            margin-top: 5px;
            text-align: left;
        }
    </style>
</head>
<body>

    <h2>æ¢ç¢¼é›™é‡æ¯”å° (Code 39 å°ˆç”¨)</h2>
    <div id="reader"></div>

    <div class="info" id="status-area">
        <div id="msg">è«‹æƒæç¬¬ä¸€å€‹ Code 39 æ¢ç¢¼</div>
        <div class="hint">â€¢ ç¢ºä¿å…‰ç·šå……è¶³</div>
        <div class="hint">â€¢ å°æº–æ¢ç¢¼ä¸¦ä¿æŒç©©å®š</div>
        
        <div style="margin: 20px 0;">
            <div class="code-box" id="display1">ç¬¬ä¸€å€‹æ¢ç¢¼: ç­‰å¾…æƒæ...</div>
            <div class="hint" id="hint1">æƒæç‹€æ…‹: æœªé–‹å§‹</div>
        </div>
        
        <div style="margin: 20px 0;">
            <div class="code-box" id="display2">ç¬¬äºŒå€‹æ¢ç¢¼: ç­‰å¾…æƒæ...</div>
            <div class="hint" id="hint2">æƒæç‹€æ…‹: æœªé–‹å§‹</div>
        </div>
        
        <button onclick="resetApp()">é‡æ–°é–‹å§‹æ¯”å°</button>
    </div>

    <script>
        let code1 = "";
        let code2 = "";
        let lastScannedTime = 0;
        const SCAN_DELAY = 1000; // 1ç§’å…§ä¸é‡è¤‡æƒæ
        const msg = document.getElementById('msg');
        const d1 = document.getElementById('display1');
        const d2 = document.getElementById('display2');
        const hint1 = document.getElementById('hint1');
        const hint2 = document.getElementById('hint2');
        const statusArea = document.getElementById('status-area');

        // Code 39 æ ¼å¼é©—è­‰
        function validateCode39(text) {
            if (!text || text.trim() === '') return false;
            
            // Code 39 å…è¨±çš„å­—å…ƒ: A-Z, 0-9, -, ., $, /, +, %, ç©ºæ ¼
            const code39Regex = /^[A-Z0-9\-\.\ \$\+\/%]*$/;
            
            // é•·åº¦æª¢æŸ¥ (Code 39 é€šå¸¸ 1-43 å€‹å­—å…ƒ)
            if (text.length < 1 || text.length > 43) {
                return false;
            }
            
            return code39Regex.test(text);
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playScanSound(success = true) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // æˆåŠŸéŸ³èª¿è¼ƒé«˜ï¼Œå¤±æ•—éŸ³èª¿è¼ƒä½
                oscillator.frequency.value = success ? 1000 : 400;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e);
            }
        }

        // è¦–è¦ºåé¥‹
        function showVisualFeedback(element, type = 'scanning') {
            element.classList.remove('scanning', 'success', 'error');
            element.classList.add(type);
            
            // æ‰‹æ©ŸæŒ¯å‹•åé¥‹
            if (navigator.vibrate) {
                if (type === 'success') {
                    navigator.vibrate([100, 50, 100]);
                } else if (type === 'error') {
                    navigator.vibrate([200]);
                }
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();
            
            // é˜²æŠ–å‹•ï¼šé˜²æ­¢çŸ­æ™‚é–“å…§é‡è¤‡æƒæ
            if (now - lastScannedTime < SCAN_DELAY) {
                return;
            }
            lastScannedTime = now;
            
            // éæ¿¾æ˜Ÿè™Ÿ
            let cleanText = decodedText.replace(/^\*|\*$/g, "");
            console.log("åŸå§‹æƒæ:", decodedText, "è™•ç†å¾Œ:", cleanText);
            
            // æš«åœæƒæå™¨
            html5QrcodeScanner.pause(true);
            
            // é©—è­‰æ¢ç¢¼æ ¼å¼
            if (!validateCode39(cleanText)) {
                msg.innerText = "âŒ æ ¼å¼éŒ¯èª¤ï¼è«‹æƒæ Code 39 æ¢ç¢¼";
                msg.style.color = "var(--error)";
                playScanSound(false);
                
                if (!code1) {
                    showVisualFeedback(d1, 'error');
                    hint1.textContent = "æƒæå¤±æ•—: é Code 39 æ ¼å¼";
                } else {
                    showVisualFeedback(d2, 'error');
                    hint2.textContent = "æƒæå¤±æ•—: é Code 39 æ ¼å¼";
                }
                
                setTimeout(() => {
                    msg.style.color = "";
                    html5QrcodeScanner.resume();
                }, 1500);
                return;
            }
            
            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            playScanSound(true);
            
            if (!code1) {
                // æƒæç¬¬ä¸€å€‹æ¢ç¢¼
                code1 = cleanText;
                d1.innerText = `ç¬¬ä¸€å€‹æ¢ç¢¼: ${code1}`;
                showVisualFeedback(d1, 'success');
                hint1.textContent = `æƒææˆåŠŸ: ${new Date().toLocaleTimeString()}`;
                
                msg.innerText = "âœ… ç¬¬ä¸€å€‹æ¢ç¢¼å·²æƒæï¼Œè«‹æƒæç¬¬äºŒå€‹æ¢ç¢¼";
                msg.style.color = "var(--primary)";
                
                // 1.5ç§’å¾Œæ¢å¾©æƒæ
                setTimeout(() => {
                    if (!code2) {
                        html5QrcodeScanner.resume();
                        d2.classList.add('scanning');
                        hint2.textContent = "æº–å‚™æƒæä¸­...";
                    }
                }, 1500);
                
            } else if (!code2) {
                // æƒæç¬¬äºŒå€‹æ¢ç¢¼
                code2 = cleanText;
                d2.innerText = `ç¬¬äºŒå€‹æ¢ç¢¼: ${code2}`;
                showVisualFeedback(d2, 'success');
                hint2.textContent = `æƒææˆåŠŸ: ${new Date().toLocaleTimeString()}`;
                
                // é€²è¡Œæ¯”å°
                setTimeout(() => {
                    compare();
                }, 500);
            }
        }

        function onScanFailure(error) {
            // æƒæå¤±æ•—çš„è™•ç†
            console.warn(`æƒæéŒ¯èª¤: ${error}`);
            // å¯ä»¥é¸æ“‡æ€§åœ°é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        }

        function compare() {
            if (code1 === code2) {
                msg.innerText = "ğŸ‰ æ¯”å°æˆåŠŸï¼å…©å€‹æ¢ç¢¼å…§å®¹å®Œå…¨ä¸€è‡´";
                msg.style.color = "var(--success)";
                statusArea.classList.add("success");
                
                // æ’­æ”¾ç‰¹åˆ¥çš„æˆåŠŸéŸ³æ•ˆ
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // æˆåŠŸæ—‹å¾‹
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {}
                
            } else {
                msg.innerText = `âŒ æ¯”å°å¤±æ•—ï¼å…§å®¹ä¸åŒ`;
                msg.style.color = "var(--error)";
                statusArea.classList.add("error");
                
                // é¡¯ç¤ºå·®ç•°è™•
                hint1.textContent += " (èˆ‡ç¬¬äºŒå€‹ä¸åŒ)";
                hint2.textContent += " (èˆ‡ç¬¬ä¸€å€‹ä¸åŒ)";
            }
            
            // å®Œå…¨åœæ­¢æƒæ
            html5QrcodeScanner.pause(true);
        }

        function resetApp() {
            code1 = "";
            code2 = "";
            lastScannedTime = 0;
            
            d1.innerText = "ç¬¬ä¸€å€‹æ¢ç¢¼: ç­‰å¾…æƒæ...";
            d2.innerText = "ç¬¬äºŒå€‹æ¢ç¢¼: ç­‰å¾…æƒæ...";
            d1.className = "code-box";
            d2.className = "code-box";
            
            hint1.textContent = "æƒæç‹€æ…‹: æœªé–‹å§‹";
            hint2.textContent = "æƒæç‹€æ…‹: æœªé–‹å§‹";
            
            msg.innerText = "è«‹æƒæç¬¬ä¸€å€‹ Code 39 æ¢ç¢¼";
            msg.style.color = "";
            statusArea.className = "info";
            
            // é‡æ–°å•Ÿå‹•æƒæå™¨
            try {
                html5QrcodeScanner.resume();
                d1.classList.add('scanning');
                hint1.textContent = "æº–å‚™æƒæä¸­...";
            } catch (e) {
                console.log("é‡æ–°å•Ÿå‹•æƒæå™¨");
            }
        }

        // åˆå§‹åŒ–æƒæå™¨
        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
            fps: 30,
            qrbox: { width: 350, height: 150 },
            aspectRatio: 4/3,
            formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_39 ],
            disableFlip: false,
            showTorchButtonIfSupported: true,  // é¡¯ç¤ºæ‰‹é›»ç­’æŒ‰éˆ•
            showZoomSliderIfSupported: true,   // é¡¯ç¤ºç¸®æ”¾æ»‘æ¡¿
        });

        // é–‹å§‹æƒæ
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        
        // åˆå§‹ç‹€æ…‹
        d1.classList.add('scanning');
        hint1.textContent = "æº–å‚™æƒæä¸­...";
        
        // æ·»åŠ ç›¸æ©Ÿé¸æ“‡åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const cameraSelect = document.createElement('select');
                cameraSelect.id = 'camera-select';
                cameraSelect.style.margin = '10px 0';
                cameraSelect.style.padding = '5px';
                
                const defaultOption = document.createElement('option');
                defaultOption.text = 'é¸æ“‡ç›¸æ©Ÿ...';
                cameraSelect.add(defaultOption);
                
                document.querySelector('.info').prepend(cameraSelect);
                
                // ç²å–ç›¸æ©Ÿåˆ—è¡¨
                Html5Qrcode.getCameras().then(cameras => {
                    if (cameras && cameras.length) {
                        cameras.forEach(camera => {
                            const option = document.createElement('option');
                            option.value = camera.id;
                            option.text = camera.label || camera.id;
                            cameraSelect.add(option);
                        });
                        
                        cameraSelect.onchange = () => {
                            if (cameraSelect.value) {
                                html5QrcodeScanner.clear();
                                html5QrcodeScanner.start(
                                    cameraSelect.value,
                                    {
                                        fps: 30,
                                        qrbox: { width: 350, height: 150 }
                                    },
                                    onScanSuccess,
                                    onScanFailure
                                );
                            }
                        };
                    }
                });
            }, 1000);
        });
    </script>
</body>
</html>
